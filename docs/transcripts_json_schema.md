# transcripts.json Schema Documentation

This document describes the JSON schema used by ferro-hgvs for transcript reference data.

## Overview

The `transcripts.json` file provides transcript annotations needed for HGVS normalization of coding (c.) and non-coding (n.) variants. The file can be created manually, generated from GFF3/GTF files using the `convert-gff` command, or exported from the MockProvider test data.

## File Structure

### Top-Level Container

When generated by `convert-gff`, the file has a container structure:

```json
{
  "version": "1.0",
  "genome_build": "GRCh38",
  "transcripts": [
    { /* transcript object */ },
    { /* transcript object */ }
  ]
}
```

For simple use cases, a flat array of transcript objects is also supported:

```json
[
  { /* transcript object */ },
  { /* transcript object */ }
]
```

## Transcript Object

Each transcript object has the following fields:

### Required Fields

| Field | Type | Description |
|-------|------|-------------|
| `id` | string | Transcript accession with version (e.g., `"NM_000088.3"`, `"ENST00000123456.5"`) |
| `sequence` | string | Full transcript sequence (5' to 3' in transcript orientation). Use `"N"` repeats if sequence unavailable. |
| `exons` | array | Array of exon objects defining the transcript structure |

### Optional Fields

| Field | Type | Description |
|-------|------|-------------|
| `gene_symbol` | string | Gene symbol (e.g., `"COL1A1"`, `"BRCA1"`) |
| `strand` | string | Strand orientation: `"+"` (plus/forward) or `"-"` (minus/reverse). Default: `"+"` |
| `cds_start` | integer | CDS start position in transcript coordinates (1-based, inclusive). `null` for non-coding transcripts. |
| `cds_end` | integer | CDS end position in transcript coordinates (1-based, inclusive). `null` for non-coding transcripts. |
| `chromosome` | string | Chromosome name (e.g., `"chr1"`, `"1"`, `"X"`) |
| `genomic_start` | integer | Transcript start position on chromosome (1-based, inclusive) |
| `genomic_end` | integer | Transcript end position on chromosome (1-based, inclusive) |
| `genome_build` | string | Assembly version: `"GRCh37"`, `"GRCh38"`, or `"unknown"`. Default: `"GRCh38"` |
| `mane_status` | string | MANE designation: `"MANE_Select"`, `"MANE_Plus_Clinical"`, or omitted if not MANE |
| `refseq_match` | string | For Ensembl transcripts: matched RefSeq accession |
| `ensembl_match` | string | For RefSeq transcripts: matched Ensembl accession |

## Exon Object

Each exon object has the following fields:

### Required Fields

| Field | Type | Description |
|-------|------|-------------|
| `number` | integer | Exon number (1-based, starting from 5' end of transcript) |
| `start` | integer | Start position in transcript coordinates (1-based, inclusive) |
| `end` | integer | End position in transcript coordinates (1-based, inclusive) |

### Optional Fields

| Field | Type | Description |
|-------|------|-------------|
| `genomic_start` | integer | Genomic start position (1-based, inclusive) |
| `genomic_end` | integer | Genomic end position (1-based, inclusive) |

## Coordinate Systems

- **Transcript coordinates**: 1-based, continuous positions along the spliced transcript (mRNA)
- **Genomic coordinates**: 1-based, positions on the chromosome
- All coordinates are **inclusive** (start and end positions are both included)

### Important Notes

1. **Transcript coordinates** are always in the 5' to 3' direction of the transcript, regardless of strand
2. **Genomic coordinates** on minus strand transcripts: `genomic_start` < `genomic_end` (always increasing on chromosome)
3. **Exon numbering** follows transcript direction (exon 1 is always the 5'-most exon of the transcript)

## Examples

### Coding Transcript (Plus Strand)

```json
{
  "id": "NM_000088.3",
  "gene_symbol": "COL1A1",
  "strand": "+",
  "sequence": "ATGCCC...TAG",
  "cds_start": 1,
  "cds_end": 4395,
  "chromosome": "chr17",
  "genomic_start": 50185804,
  "genomic_end": 50202654,
  "genome_build": "GRCh38",
  "mane_status": "MANE_Select",
  "exons": [
    {
      "number": 1,
      "start": 1,
      "end": 100,
      "genomic_start": 50185804,
      "genomic_end": 50185903
    },
    {
      "number": 2,
      "start": 101,
      "end": 250,
      "genomic_start": 50186500,
      "genomic_end": 50186649
    }
  ]
}
```

### Coding Transcript (Minus Strand)

```json
{
  "id": "NM_007294.4",
  "gene_symbol": "BRCA1",
  "strand": "-",
  "sequence": "ATGCGA...TGA",
  "cds_start": 100,
  "cds_end": 5700,
  "chromosome": "chr17",
  "genomic_start": 43044295,
  "genomic_end": 43170245,
  "genome_build": "GRCh38",
  "mane_status": "MANE_Select",
  "exons": [
    {
      "number": 1,
      "start": 1,
      "end": 200,
      "genomic_start": 43170045,
      "genomic_end": 43170245
    },
    {
      "number": 2,
      "start": 201,
      "end": 400,
      "genomic_start": 43104867,
      "genomic_end": 43105067
    }
  ]
}
```

### Non-Coding Transcript

```json
{
  "id": "NR_000001.2",
  "gene_symbol": "NCRNA1",
  "strand": "+",
  "sequence": "ACGTACGT...",
  "cds_start": null,
  "cds_end": null,
  "exons": [
    { "number": 1, "start": 1, "end": 500 }
  ]
}
```

### Minimal Example (Basic Normalization)

For basic HGVS normalization without genomic coordinates:

```json
[
  {
    "id": "NM_000088.3",
    "sequence": "ATGCCCAAAGGG",
    "cds_start": 1,
    "cds_end": 12,
    "exons": [
      { "number": 1, "start": 1, "end": 12 }
    ]
  }
]
```

## Generating transcripts.json

### From GFF3/GTF with FASTA

Use the `convert-gff` command to generate `transcripts.json` from annotation files:

```bash
# Convert GENCODE GTF with sequences from reference FASTA
ferro convert-gff \
  --gff gencode.v44.annotation.gtf \
  --fasta GRCh38.fa \
  --mane-only \
  -o transcripts.json

# Filter to specific genes
ferro convert-gff \
  --gff annotations.gff3 \
  --genes BRCA1,BRCA2,TP53 \
  --fasta reference.fa \
  -o clinical_genes.json
```

### Programmatically

```rust
use ferro_hgvs::reference::transcript::{Transcript, Exon, Strand};
use serde_json;

let transcript = Transcript {
    id: "NM_000088.3".to_string(),
    gene_symbol: Some("COL1A1".to_string()),
    strand: Strand::Plus,
    sequence: "ATGCCC...".to_string(),
    cds_start: Some(1),
    cds_end: Some(4395),
    exons: vec![
        Exon::new(1, 1, 100),
        Exon::new(2, 101, 250),
    ],
    chromosome: Some("chr17".to_string()),
    genomic_start: Some(50185804),
    genomic_end: Some(50202654),
    genome_build: GenomeBuild::GRCh38,
    mane_status: ManeStatus::Select,
    refseq_match: None,
    ensembl_match: None,
};

let json = serde_json::to_string_pretty(&vec![transcript])?;
```

## Using transcripts.json

### With the CLI

```bash
# Recommended: Prepare reference data using ferro prepare
ferro prepare --output-dir ferro-reference
ferro normalize --reference ferro-reference/ 'NM_000088.3:c.100del'

# Use with VCF annotation
ferro annotate-vcf --gff transcripts.gff3 -i input.vcf -o output.vcf
```

### Programmatically

```rust
use ferro_hgvs::{MockProvider, Normalizer, NormalizeConfig};

let provider = MockProvider::from_json("transcripts.json")?;
let normalizer = Normalizer::new(provider);

let variant = ferro_hgvs::parse_hgvs("NM_000088.3:c.100del")?;
let normalized = normalizer.normalize(&variant)?;
```

## Validation

The schema is validated when loading. Common validation errors:

| Error | Cause |
|-------|-------|
| `ReferenceNotFound` | Transcript ID not in database |
| `InvalidCoordinates` | Position exceeds sequence length |
| `Parse error` | Malformed JSON or missing required fields |

## Best Practices

1. **Include version numbers** in transcript IDs (e.g., `NM_000088.3` not `NM_000088`)
2. **Provide full sequences** when possible for accurate normalization
3. **Use MANE transcripts** for clinical applications
4. **Include genomic coordinates** if you need VCF-to-HGVS conversion
5. **Validate sequence length** matches exon coordinates: `sum(exon lengths) == sequence.len()`
